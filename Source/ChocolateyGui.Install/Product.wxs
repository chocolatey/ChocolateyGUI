<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" 
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">
  <?define MainExe=$(var.ChocolateyGui.TargetFileName)?>
  <?define Version=!(bind.fileVersion.$(var.MainExe))?>
  <?define ProductName="ChocolateyGUI" ?>
  <?define Language="1033" ?>
  <?define Manufacturer="Chocolatey"?>
  <?define ChocolateyGui_TargetDir=$(var.ChocolateyGui.TargetDir)?>

  <Product Id="*" Name="$(var.ProductName)" Language="$(var.Language)" Version="$(var.Version)" Manufacturer="$(var.Manufacturer)" UpgradeCode="f8164f91-fa5c-4789-b68d-9beb5b146155">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />

    <PropertyRef Id="WIX_IS_NETFRAMEWORK_452_OR_LATER_INSTALLED" />    
    <SetProperty Id="CHOCOLATEY_INSTALL" Value="$(env.ChocolateyInstall)" Before="LaunchConditions" Sequence="first"  />


    <Condition Message="This application requires .NET Framework 4.5.2. Please install the .NET 4.5.2 Framework then run this installer again.">
      <![CDATA[Installed OR WIX_IS_NETFRAMEWORK_452_OR_LATER_INSTALLED]]>
    </Condition>

    <Condition Message="This application only runs in Windows 7 SP1 or later.">
      <![CDATA[Installed OR (VersionNT >= 601)]]>
    </Condition>

    <Condition Message="Chocolatey must already be installed.">
      <![CDATA[CHOCOLATEY_INSTALL]]>
    </Condition>

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <?if $(var.ChocolateyGui.Configuration) = "Debug"?>
    <MediaTemplate EmbedCab="yes" CompressionLevel="none" />
    <?else?>
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />
    <?endif?>

    <Icon Id="icon.ico" SourceFile="$(var.ChocolateyGui.ProjectDir)\chocolateyicon.ico" />
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />

    <Feature Id="ProductFeature" Title="ChocolateyGUI" Level="1">
      <ComponentGroupRef Id="ChocolateyExe" />
      <ComponentGroupRef Id="ApplicationContent" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="CreateAppDataFolder" />
      <ComponentRef Id="CreateUserAppDataFolder" />
      <MergeRef Id="VCRedist" />
    </Feature>
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="ChocolateyGUI" />
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Component Id="ApplicationShortcut" Guid="A508A8D8-4F82-4AA9-AB70-E1022B9A9EAC">
          <Shortcut Id="ApplicationStartMenuShortcut" Advertise="no"
                    Name="ChocolateyGUI" 
                    Description="GUI for Chocolatey" 
                    Target="[INSTALLFOLDER]ChocolateyGui.exe" 
                    WorkingDirectory="INSTALLFOLDER" 
                    Icon="icon.ico" />
        </Component>
      </Directory>
      <Directory Id="CommonAppDataFolder">
        <Directory Id="CommonAppStuff" Name="ChocolateyGUI">
          <Component Id="CreateAppDataFolder" Guid="D534FECA-E69F-4DE6-A2CD-192C6149BCC2">
            <CreateFolder>
              <Permission User="Everyone" GenericAll="yes" />
            </CreateFolder>
          </Component>
        </Directory>
      </Directory>
      <Directory Id="LocalAppDataFolder">
        <Directory Id="UserAppStuff" Name="ChocolateyGUI">
          <Component Id="CreateUserAppDataFolder" Guid="265AADCF-FCC7-45F1-8E2B-506F0B426D37">
            <CreateFolder />
            <RemoveFolder Id="UserAppStuff" On="uninstall" />
          </Component>
        </Directory>
      </Directory>
      <Merge Id="VCRedist" SourceFile="Microsoft_VC120_CRT_x86.msm" DiskId="1" Language="0" />
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ChocolateyExe" Directory="INSTALLFOLDER">
      <Component Id="ChocolateyGui.exe" Guid="f8164f91-fa5c-0001-0001-9beb5a044699">
        <File Id="ChocolateyGui.exe" Source="$(var.ChocolateyGui.TargetPath)" KeyPath="yes" Checksum="yes" />
      </Component>
      <Component Id="ChocolateyGui.exe.config" Guid="6C3AE56F-1AA3-4145-BFA9-345BBCC5C3D1">
        <File Id="ChocolateyGui.exe.config" Source="$(var.ChocolateyGui_TargetDir)/ChocolateyGui.exe.config" KeyPath="yes" Checksum="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>